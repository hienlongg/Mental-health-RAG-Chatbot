â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      APP.PY STRUCTURE GUIDE                               â•‘
â•‘                  Psychology RAG Chatbot Code Organization                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ QUICK NAVIGATION

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Section             â”‚ Lines  â”‚ Purpose                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Module Doc       â”‚ 1-14   â”‚ Overview of the entire application          â”‚
â”‚ 2. IMPORTS          â”‚ 16-49  â”‚ All library imports (std, 3rd-party, lang)  â”‚
â”‚ 3. CONFIG & LOG     â”‚ 52-80  â”‚ Logging setup, environment validation       â”‚
â”‚ 4. RAG INIT         â”‚ 83-118 â”‚ Initialize embeddings, model, vector store  â”‚
â”‚ 5. DOC LOADING      â”‚ 121-165â”‚ Load PDFs, chunk, index (smart caching)    â”‚
â”‚ 6. DATA PERSIST     â”‚ 168-253â”‚ Save/load chat, diagnosis, backend API      â”‚
â”‚ 7. AGENT STATE      â”‚ 256-334â”‚ State schema, tools (retrieve, diagnose)    â”‚
â”‚ 8. AGENT CREATE     â”‚ 337-355â”‚ SYSTEM_PROMPT, agent instantiation         â”‚
â”‚ 9. CHAINLIT HNDLRS  â”‚ 358-483â”‚ Chat handlers (start, message, end)        â”‚
â”‚ 10. ENTRY POINT     â”‚ 486-532â”‚ Main execution logic                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ” FIND WHAT YOU NEED

â”œâ”€ To modify logging?
â”‚  â””â”€â†’ Section 3: CONFIGURATION & LOGGING
â”‚      â””â”€ Function: setup_logging()
â”‚
â”œâ”€ To add a new tool?
â”‚  â””â”€â†’ Section 7: AGENT STATE & TOOLS
â”‚      â””â”€ Add @tool decorated function
â”‚      â””â”€ Add to tools list in Section 8
â”‚
â”œâ”€ To change the chat behavior?
â”‚  â””â”€â†’ Section 9: CHAINLIT EVENT HANDLERS
â”‚      â””â”€ on_chat_start() for session init
â”‚      â””â”€ on_message() for processing
â”‚
â”œâ”€ To modify AI system prompt?
â”‚  â””â”€â†’ Section 8: AGENT CREATION
â”‚      â””â”€ Variable: SYSTEM_PROMPT
â”‚
â”œâ”€ To change storage logic?
â”‚  â””â”€â†’ Section 6: DATA PERSISTENCE
â”‚      â””â”€ Function: save_chat_history()
â”‚      â””â”€ Function: load_chat_history()
â”‚
â”œâ”€ To adjust RAG components?
â”‚  â””â”€â†’ Section 4: RAG COMPONENT INITIALIZATION
â”‚      â””â”€ Function: initialize_embeddings()
â”‚      â””â”€ Function: initialize_model()
â”‚      â””â”€ Function: initialize_vector_store()
â”‚
â””â”€ To fix imports?
   â””â”€â†’ Section 2: IMPORTS
       â””â”€ Organize by type (std, 3rd-party, langchain)


ğŸ“Š SECTION DETAILS

1ï¸âƒ£  MODULE DOCSTRING (Lines 1-14)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ What it is: Overview & architecture
   â”‚ Key info:  LLM, embeddings, DB, UI
   â”‚ Modify?    When architecture changes
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2ï¸âƒ£  IMPORTS (Lines 16-49)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Standard library (os, sys, uuid)
   â”‚ Third-party (dotenv, chainlit)
   â”‚ LangChain ecosystem imports
   â”‚ Keep organized by category!
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3ï¸âƒ£  CONFIGURATION & LOGGING (Lines 52-80)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ setup_logging()
   â”‚   â””â”€ Creates .logs directory
   â”‚   â””â”€ Configures file + console
   â”‚
   â”‚ load_environment()
   â”‚   â””â”€ Validates API keys
   â”‚   â””â”€ Returns (langsmith_key, google_key)
   â”‚
   â”‚ Module-level init:
   â”‚   â””â”€ logger = setup_logging()
   â”‚   â””â”€ LANGSMITH_API_KEY, GOOGLE_API_KEY
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4ï¸âƒ£  RAG INITIALIZATION (Lines 83-118)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ initialize_embeddings()
   â”‚   â””â”€ Returns HuggingFaceEmbeddings
   â”‚   â””â”€ Model: all-MiniLM-L6-v2
   â”‚
   â”‚ initialize_model()
   â”‚   â””â”€ Returns ChatGoogleGenerativeAI
   â”‚   â””â”€ Model: gemini-2.5-flash-lite
   â”‚
   â”‚ initialize_vector_store(embeddings)
   â”‚   â””â”€ Returns Chroma instance
   â”‚   â””â”€ Persists to .data/embeddings/...
   â”‚
   â”‚ Module-level instantiation:
   â”‚   â””â”€ embeddings = initialize_embeddings()
   â”‚   â””â”€ model = initialize_model()
   â”‚   â””â”€ vector_store = initialize_vector_store()
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5ï¸âƒ£  DOCUMENT LOADING (Lines 121-165)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ load_and_index_documents()
   â”‚   â”œâ”€ Check if PDF exists
   â”‚   â”œâ”€ Smart caching (skip if indexed)
   â”‚   â”œâ”€ Load with PyPDFLoader
   â”‚   â”œâ”€ Chunk with RecursiveTextSplitter
   â”‚   â””â”€ Index with vector_store.add_documents()
   â”‚
   â”‚ Called immediately:
   â”‚   â””â”€ load_and_index_documents()
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

6ï¸âƒ£  DATA PERSISTENCE (Lines 168-253)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ save_chat_history(user_id, ...)
   â”‚   â””â”€ Saves to data/chats/*.json
   â”‚   â””â”€ Includes messages + diagnosis
   â”‚
   â”‚ load_chat_history(user_id, ...)
   â”‚   â””â”€ Loads from data/chats/*.json
   â”‚   â””â”€ Returns (messages, diagnosis)
   â”‚
   â”‚ save_to_backend_api(thread_id, ...)
   â”‚   â””â”€ ASYNC function
   â”‚   â””â”€ Posts to Flask backend
   â”‚   â””â”€ Saves conversation + diagnosis
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

7ï¸âƒ£  AGENT STATE & TOOLS (Lines 256-334)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ PsychologyAgentState class
   â”‚   â””â”€ user_id: str
   â”‚   â””â”€ score: str
   â”‚   â””â”€ content: str
   â”‚   â””â”€ total_guess: str
   â”‚
   â”‚ @tool retrieve_context(query)
   â”‚   â””â”€ Searches vector store
   â”‚   â””â”€ Returns DSM-5 info
   â”‚
   â”‚ @tool update_diagnosis(score, ...)
   â”‚   â””â”€ Saves diagnosis to session
   â”‚   â””â”€ Logs assessment data
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

8ï¸âƒ£  AGENT CREATION (Lines 337-355)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ SYSTEM_PROMPT = """..."""
   â”‚   â””â”€ Vietnamese instructions
   â”‚   â””â”€ 3 steps for agent behavior
   â”‚
   â”‚ tools = [retrieve_context, ...]
   â”‚   â””â”€ List of available tools
   â”‚
   â”‚ checkpointer = InMemorySaver()
   â”‚   â””â”€ Memory management
   â”‚
   â”‚ agent = create_agent(...)
   â”‚   â””â”€ Full agent instantiation
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

9ï¸âƒ£  CHAINLIT HANDLERS (Lines 358-483)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ @cl.on_chat_start
   â”‚   async def on_chat_start()
   â”‚     â”œâ”€ Create thread_id + user_id
   â”‚     â”œâ”€ Load chat history
   â”‚     â”œâ”€ Load previous diagnosis
   â”‚     â””â”€ Send welcome message
   â”‚
   â”‚ @cl.on_message
   â”‚   async def on_message(message)
   â”‚     â”œâ”€ Get session info
   â”‚     â”œâ”€ Add to message history
   â”‚     â”œâ”€ Run agent.astream()
   â”‚     â”œâ”€ Stream response tokens
   â”‚     â”œâ”€ Save to file
   â”‚     â””â”€ Save to backend API
   â”‚
   â”‚ @cl.on_chat_end
   â”‚   def on_chat_end()
   â”‚     â””â”€ Log disconnection
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”Ÿ ENTRY POINT (Lines 486-532)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ if __name__ == "__main__":
   â”‚   â”œâ”€ Print startup banner
   â”‚   â”œâ”€ Show startup instructions
   â”‚   â””â”€ Display URL
   â”‚
   â”‚ Usage:
   â”‚   $ chainlit run src/app.py
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ğŸš€ QUICK REFERENCE

Function Locations:
  setup_logging()                 â†’ Line 54
  load_environment()              â†’ Line 67
  initialize_embeddings()         â†’ Line 88
  initialize_model()              â†’ Line 95
  initialize_vector_store()       â†’ Line 102
  load_and_index_documents()      â†’ Line 123
  save_chat_history()             â†’ Line 170
  load_chat_history()             â†’ Line 190
  save_to_backend_api()           â†’ Line 207
  PsychologyAgentState            â†’ Line 258
  retrieve_context()              â†’ Line 263
  update_diagnosis()              â†’ Line 283
  on_chat_start()                 â†’ Line 360
  on_message()                    â†’ Line 385
  on_chat_end()                   â†’ Line 470

Variables:
  logger                          â†’ Line 79
  embeddings                      â†’ Line 115
  model                           â†’ Line 116
  vector_store                    â†’ Line 117
  tools                           â†’ Line 339
  checkpointer                    â†’ Line 340
  agent                           â†’ Line 342
  SYSTEM_PROMPT                   â†’ Line 337


âœ¨ BEST PRACTICES

1. Keep sections in order (don't mix them)
2. Add new functions to appropriate sections
3. Update module docstring if architecture changes
4. Always use type hints
5. Always add docstrings
6. Always use logger instead of print
7. Keep imports organized (std, 3rd-party, langchain)
8. Use section comments for navigation


ğŸ“ ADDING NEW FEATURES

New Tool:
  1. Add to AGENT STATE & TOOLS section
  2. Decorate with @tool
  3. Add to tools list in AGENT CREATION
  
New Handler:
  1. Add to CHAINLIT EVENT HANDLERS section
  2. Follow @cl.on_* pattern
  
New Config Option:
  1. Update load_environment() in CONFIG section
  2. Use throughout with os.getenv()


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Your code is now ORGANIZED, MAINTAINABLE, and PRODUCTION-READY! ğŸ‰       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
